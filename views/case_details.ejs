<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case Details - <%= caseId %></title>
    <link rel="stylesheet" href="/assets/css/side_menu.css">
    <link rel="stylesheet" href="/assets/css/case_details.css">
    <script src="/assets/js/components.js"></script>
    <script>
        window.CASE_ID = "<%= caseId %>";
    </script>
</head>
<body>
    <!-- Navigation Rail Component -->
    <div id="navRail"></div>

    <!-- Main Content -->
    <main class="main-content">
        <div class="content-container">
            <!-- Breadcrumb -->
            <nav class="breadcrumb">
                <a href="/aligners-cases" class="breadcrumb-item">Home</a>
                <span class="breadcrumb-separator">
                    <img src="/assets/images/breadcrumb-arrow.svg" alt="Breadcrumb Arrow">
                </span>
                <span class="breadcrumb-item active">Case Details C0000<%= caseId %></span>
            </nav>

            <!-- Page Header -->
            <div class="page-header">
                <div class="page-header-left">
                    <div class="title-badges-row">
                        <h1 class="page-title">C0000<%= caseId %></h1>
                        <div class="page-badges">
                            <span class="pill-badge badge-blue" id="badgeCategory">New Case</span>
                            <span class="pill-badge badge-green" id="badgeStatus">Submitted</span>
                        </div>
                    </div>
                    <div class="subtitle" id="submittedSubtitle">Submitted on 20/6/2025</div>
                </div>
                <div class="page-actions">
                    <button class="btn btn-outline" id="addPlanBtn">Add Treatment Plan</button>
                    <button class="btn btn-primary" id="setDraftBtn">Set as Draft</button>
                </div>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" data-tab="patient">Patient Details</button>
                <button class="tab" data-tab="treatment">Treatment Details</button>
                <button class="tab" data-tab="simulations">Simulations</button>
                <button class="tab" data-tab="comments">Comments</button>
                <button class="tab" data-tab="attachments">Attachments</button>
            </div>

            <!-- Patient Details Panel -->
            <section class="tab-panel" id="panel-patient">
                <div class="patient-details-container">
                    <div class="patient-header">
                        <div class="avatar" id="patientAvatar">J</div>
                        <div class="identity">
                            <div class="name" id="patientName">Jennifer Tan Yi Wen</div>
                            <div class="meta" id="patientId">Patient ID: 13989023001</div>
                        </div>
                    </div>
                    
                    <div class="patient-info-grid">
                        <div class="info-row">
                            <div class="info-item">
                                <label>Gender</label>
                                <span id="kvGender">Female</span>
                            </div>
                            <div class="info-item">
                                <label>Date of Birth</label>
                                <span id="kvDob">12/02/1996</span>
                            </div>
                            <div class="info-item">
                                <label>Email</label>
                                <span id="kvEmail">-</span>
                            </div>
                        </div>
                        <div class="info-row">
                            <div class="info-item">
                                <label>Treatment Brand</label>
                                <span id="kvBrand">DCA Pro</span>
                            </div>
                            <div class="info-item">
                                <label>Category</label>
                                <span id="kvCategory">New Case</span>
                            </div>
                            <div class="info-item">
                                <label>Custom SN</label>
                                <span id="kvCustomSn">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Treatment Details Panel -->
            <section class="tab-panel hidden" id="panel-treatments">
                <!-- Clinical Data Section -->
                <div class="treatment-container">
                    <h3 class="treatment-section-title">Clinical Data</h3>
                    <div class="treatment-content">
                        <div class="treatment-field">
                            <label>Clinical Condition</label>
                            <span class="treatment-value">Spacing, Class II div 2</span>
                        </div>
                        <div class="treatment-row">
                            <div class="treatment-field">
                                <label>IPR</label>
                                <span class="treatment-value">As Recommended</span>
                            </div>
                            <div class="treatment-field">
                                <label>Attachments</label>
                                <span class="treatment-value">As Recommended</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Treatment Notes Section -->
                <div class="treatment-container">
                    <h3 class="treatment-section-title">Treatment Notes</h3>
                    <div class="treatment-content">
                        <div class="treatment-field">
                            <label>Notes</label>
                            <div class="treatment-notes">
                                <div class="notes-label">Customer's desire:</div>
                                <ul class="notes-list">
                                    <li>Arrange teeth</li>
                                    <li>Improve open bite</li>
                                    <li>Reduce protrusion</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            <section class="tab-panel hidden" id="panel-simulations">
                <div class="simulations-container">
                    <div class="simulation-plan">
                        <h2 class="plan-title">Plan 1</h2>
                        <div class="plan-divider"></div>
                        <p class="plan-instruction">Please click the box to view simulation or download document.</p>
                        
                        <div class="simulation-details">
                            <div class="detail-item">
                                <label>Date Uploaded</label>
                                <span class="detail-value">23/07/2025</span>
                            </div>
                            
                            <div class="detail-item">
                                <label>Simulation URL</label>
                                <div class="url-field">
                                    <img src="/assets/images/external-link-icon.svg" alt="External Link" class="field-icon">
                                    <span class="url-text">https://dca.patientalignerplan.com/Viewer/show.html?mlink...</span>
                                </div>
                            </div>
                            
                            <div class="detail-item">
                                <label>IPR (*PDF)</label>
                                <div class="pdf-field">
                                    <img src="/assets/images/document-icon.svg" alt="Document" class="field-icon">
                                    <span class="pdf-text">17350043-RKE-7808.pdf</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            <section class="tab-panel hidden" id="panel-comments">
                <div class="comments-section">
                    <!-- Comment Item 1 -->
                    <div class="comment-container">
                        <div class="comment-item">
                            <div class="comment-avatar">K</div>
                            <div class="comment-content">
                                <div class="comment-header">
                                    <span class="comment-author">Khoo Ming Sheng</span>
                                    <span class="comment-time">07/09/2025 10:52</span>
                                </div>
                                <div class="comment-text">
                                    Pls fabricate ULT+ UL set 1-5 +before model<br>
                                    Use DCA Lab<br>
                                    ETD before 21 October 2024
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Comment Item 2 -->
                    <div class="comment-container">
                        <div class="comment-item">
                            <div class="comment-avatar">K</div>
                            <div class="comment-content">
                                <div class="comment-header">
                                    <span class="comment-author">Khoo Ming Sheng</span>
                                    <span class="comment-time">07/09/2025 14:02</span>
                                </div>
                                <div class="comment-text">
                                    Pls fabricate UL set 6-18<br>
                                    Use DCA Lab<br>
                                    ETD before 17 November 2024
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Comment Input Section -->
                    <div class="comment-input-section">
                        <div class="comment-input-container">
                            <textarea class="comment-input" placeholder="Write a comment..."></textarea>
                            <button class="btn btn-primary comment-submit">Send</button>
                        </div>
                    </div>
                </div>
            </section>
            <section class="tab-panel hidden" id="panel-attachments">
                <!-- Model Section in its own container -->
                <div class="attachments-container">
                    <div class="attachment-section">
                        <h3 class="attachment-section-title">Model</h3>
                        <p class="attachment-section-subtitle">Please click <a href="#" class="link">here</a> to download all models.</p>
                        
                        <div class="attachment-files">
                            <!-- Upper Scan -->
                            <div class="attachment-file">
                                <div class="attachment-file-overlay">
                                    <div class="attachment-file-overlay-icon">
                                        <img src="/assets/images/enlarge-picture.svg" alt="Enlarge" style="width: 18.75px; height: 18.751px;">
                                    </div>
                                </div>
                                <div class="attachment-file-name">1241228053-upperjaw.stl</div>
                                <div class="attachment-file-info">Upper Scan</div>
                            </div>
                            
                            <!-- Lower Scan -->
                            <div class="attachment-file">
                                <div class="attachment-file-overlay">
                                    <div class="attachment-file-overlay-icon">
                                        <img src="/assets/images/enlarge-picture.svg" alt="Enlarge" style="width: 18.75px; height: 18.751px;">
                                    </div>
                                </div>
                                <div class="attachment-file-name">2412280553-lowerjaw.stl</div>
                                <div class="attachment-file-info">Lower Scan</div>
                            </div>
                            
                            <!-- Bite Scan -->
                            <div class="attachment-file">
                                <div class="attachment-file-overlay">
                                    <div class="attachment-file-overlay-icon">
                                        <img src="/assets/images/enlarge-picture.svg" alt="Enlarge" style="width: 18.75px; height: 18.751px;">
                                    </div>
                                </div>
                                <div class="attachment-file-name">2412280553-biteregister1.stl</div>
                                <div class="attachment-file-info">Bite Scan</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Clinical Photos Section in its own container -->
                <div class="attachments-container">
                    <div class="attachment-section">
                        <h3 class="attachment-section-title">Clinical Photos</h3>
                        <p class="attachment-section-subtitle">Please click <a href="#" class="link">here</a> to download all photos.</p>
                        
                        <!-- First Row - Face Photos -->
                        <div class="attachment-files-row">
                            <div class="attachment-file">
                                <div class="attachment-file-overlay">
                                    <div class="attachment-file-overlay-icon">
                                        <img src="/assets/images/enlarge-picture.svg" alt="Enlarge" style="width: 18.75px; height: 18.751px;">
                                    </div>
                                </div>
                                <img src="/assets/images/placeholder1.png" alt="Full Face Front">

                            </div>
                            
                            <div class="attachment-file">
                                <div class="attachment-file-overlay">
                                    <div class="attachment-file-overlay-icon">
                                        <img src="/assets/images/enlarge-picture.svg" alt="Enlarge" style="width: 18.751px; height: 18.751px;">
                                    </div>
                                </div>
                                <img src="/assets/images/placeholder3.png" alt="Full Smiling Face">

                            </div>
                            
                            <div class="attachment-file">
                                <div class="attachment-file-overlay">
                                    <div class="attachment-file-overlay-icon">
                                        <img src="/assets/images/enlarge-picture.svg" alt="Enlarge" style="width: 18.75px; height: 18.751px;">
                                    </div>
                                </div>
                                <img src="/assets/images/placeholder1.png" alt="Right Side Profile">
                           
                            </div>
                        </div>
                        
                        <!-- Second Row - Intraoral Photos -->
                        <div class="attachment-files-row">
                            <div class="attachment-file">
                                <div class="attachment-file-overlay">
                                    <div class="attachment-file-overlay-icon">
                                        <img src="/assets/images/enlarge-picture.svg" alt="Enlarge" style="width: 18.75px; height: 18.751px;">
                                    </div>
                                </div>
                                <img src="/assets/images/placeholder2.png" alt="Buccal Right">

                            </div>
                            
                            <div class="attachment-file">
                                <div class="attachment-file-overlay">
                                    <div class="attachment-file-overlay-icon">
                                        <img src="/assets/images/enlarge-picture.svg" alt="Enlarge" style="width: 18.75px; height: 18.751px;">
                                    </div>
                                </div>
                                <img src="/assets/images/placeholder2.png" alt="Retracted Anterior Frontal">
                         
                            </div>
                            
                            <div class="attachment-file">
                                <div class="attachment-file-overlay">
                                    <div class="attachment-file-overlay-icon">
                                        <img src="/assets/images/enlarge-picture.svg" alt="Enlarge" style="width: 18.75px; height: 18.751px;">
                                    </div>
                                </div>
                                <img src="/assets/images/placeholder2.png" alt="Buccal Left">
  
                            </div>
                            
                            <div class="attachment-file">
                                <div class="attachment-file-overlay">
                                    <div class="attachment-file-overlay-icon">
                                        <img src="/assets/images/enlarge-picture.svg" alt="Enlarge" style="width: 18.75px; height: 18.751px;">
                                    </div>
                                </div>
                                <img src="/assets/images/placeholder2.png" alt="Maxillary Occlusal">
                           
                            </div>
                            
                            <div class="attachment-file">
                                <div class="attachment-file-overlay">
                                    <div class="attachment-file-overlay-icon">
                                        <img src="/assets/images/enlarge-picture.svg" alt="Enlarge" style="width: 18.75px; height: 18.751px;">
                                    </div>
                                </div>
                                <img src="/assets/images/placeholder2.png" alt="Mandibular Occlusal">
             
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- X-Ray Section in its own container -->
                <div class="attachments-container">
                    <div class="attachment-section">
                        <h3 class="attachment-section-title">X-Ray</h3>
                        <p class="attachment-section-subtitle">No file uploaded.</p>
                    </div>
                </div>
                
                <!-- Other Documents/Photos Section in its own container -->
                <div class="attachments-container">
                    <div class="attachment-section">
                        <h3 class="attachment-section-title">Other Documents / Photos</h3>
                        <p class="attachment-section-subtitle">No file uploaded.</p>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Photo Modal -->
    <div id="photoModal" class="photo-modal">
        <div class="photo-modal-content">
            <div class="photo-modal-header">
                <h3 class="photo-modal-title">View Image(s)</h3>
                <span class="photo-modal-close">&times;</span>
            </div>
            <div class="photo-modal-body">
                <div class="photo-modal-layout">
                    <div class="photo-modal-main-image">
                        <img id="modalMainImage" src="" alt="Selected Image">
                    </div>
                    <div class="photo-modal-thumbnails">
                        <p>Select an image to enlarge:</p>
                        <div class="photo-modal-thumbnail-grid" id="photoThumbnails">
                            <!-- Thumbnails will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            loadComponent('navRail', '/views/components/side-menu.ejs');

            // Add treatment plan button
            const addPlanBtn = document.getElementById('addPlanBtn');
            addPlanBtn.addEventListener('click', () => {
                window.location.href = `/add-treatment-plan/${window.CASE_ID}`;
            });

            // Tab switching functionality
            const tabEls = document.querySelectorAll('.tab');
            const panels = {
                patient: document.getElementById('panel-patient'),
                treatment: document.getElementById('panel-treatments'),
                simulations: document.getElementById('panel-simulations'),
                comments: document.getElementById('panel-comments'),
                attachments: document.getElementById('panel-attachments'),
            };
            
            tabEls.forEach(btn => {
                btn.addEventListener('click', () => {
                    // Remove active class from all tabs
                    tabEls.forEach(b => b.classList.remove('active'));
                    // Add active class to clicked tab
                    btn.classList.add('active');
                    
                    // Show/hide panels
                    const tab = btn.getAttribute('data-tab');
                    Object.entries(panels).forEach(([key, el]) => {
                        if (!el) return;
                        el.classList.toggle('hidden', key !== tab);
                    });
                });
            });

            // TODO: Replace with real API call to fetch case data by CASE_ID
            // fetch(`/api/cases/${window.CASE_ID}`)
            //   .then(response => response.json())
            //   .then(data => {
            //     // Populate the page with real data
            //   });
            
            // Photo Modal Functionality
            const photoModal = document.getElementById('photoModal');
            const modalMainImage = document.getElementById('modalMainImage');
            const photoThumbnails = document.getElementById('photoThumbnails');
            const modalClose = document.querySelector('.photo-modal-close');
            
            // Find the clinical photos section
            const clinicalPhotosSection = Array.from(document.querySelectorAll('.attachment-section-title')).find(
                el => el.textContent.trim() === 'Clinical Photos'
            )?.closest('.attachment-section');
            
            // Get all clinical photos if section exists
            let clinicalPhotoFiles = [];
            if (clinicalPhotosSection) {
                const clinicalPhotos = clinicalPhotosSection.querySelectorAll('.attachment-file img');
                clinicalPhotoFiles = Array.from(clinicalPhotos).map(img => {
                    return {
                        src: img.src,
                        alt: img.alt
                    };
                });
                
                // Add click event to all clinical photos
                clinicalPhotosSection.querySelectorAll('.attachment-file').forEach((photoElement, index) => {
                    photoElement.addEventListener('click', () => {
                        openPhotoModal(index);
                    });
                });
            }
            
            // Close modal when clicking the X
            modalClose.addEventListener('click', () => {
                photoModal.classList.remove('active');
                document.removeEventListener('keydown', handleKeyNavigation);
            });
            
            // Close modal when clicking outside of it
            window.addEventListener('click', (event) => {
                if (event.target === photoModal) {
                    photoModal.classList.remove('active');
                    document.removeEventListener('keydown', handleKeyNavigation);
                }
            });
            
            // Function to open modal with specific image
            function openPhotoModal(selectedIndex) {
                // Clear existing thumbnails
                photoThumbnails.innerHTML = '';
                
                // Create thumbnails for all images EXCEPT the selected one
                clinicalPhotoFiles.forEach((photo, index) => {
                    if (index !== selectedIndex) {
                        const thumbnail = document.createElement('div');
                        thumbnail.className = 'photo-modal-thumbnail';
                        thumbnail.setAttribute('tabindex', '0'); // Make focusable for keyboard navigation
                        
                        const thumbnailImg = document.createElement('img');
                        thumbnailImg.src = photo.src;
                        thumbnailImg.alt = photo.alt;
                        
                        thumbnail.appendChild(thumbnailImg);
                        photoThumbnails.appendChild(thumbnail);
                        
                        // Add click event to thumbnail
                        thumbnail.addEventListener('click', () => {
                            changeImage(index);
                        });
                        
                        // Add keyboard event for accessibility
                        thumbnail.addEventListener('keydown', (event) => {
                            if (event.key === 'Enter' || event.key === ' ') {
                                event.preventDefault();
                                changeImage(index);
                            }
                        });
                    }
                });
                
                // Set main image
                if (clinicalPhotoFiles[selectedIndex]) {
                    modalMainImage.src = clinicalPhotoFiles[selectedIndex].src;
                    modalMainImage.alt = clinicalPhotoFiles[selectedIndex].alt;
                }
                
                // Show modal
                photoModal.classList.add('active');
                
                // Set up keyboard navigation
                document.addEventListener('keydown', handleKeyNavigation);
            }
            
            // Function to change the displayed image
            function changeImage(index) {
                if (index < 0) {
                    index = clinicalPhotoFiles.length - 1;
                } else if (index >= clinicalPhotoFiles.length) {
                    index = 0;
                }
                
                // Get current displayed image index
                const currentImageSrc = modalMainImage.src;
                const currentIndex = clinicalPhotoFiles.findIndex(photo => photo.src === currentImageSrc);
                
                // Update main image
                modalMainImage.src = clinicalPhotoFiles[index].src;
                modalMainImage.alt = clinicalPhotoFiles[index].alt;
                
                // Rebuild thumbnail list: remove current image, add previous image back
                photoThumbnails.innerHTML = '';
                
                clinicalPhotoFiles.forEach((photo, i) => {
                    if (i !== index) { // Don't show the currently enlarged image
                        const thumbnail = document.createElement('div');
                        thumbnail.className = 'photo-modal-thumbnail';
                        thumbnail.setAttribute('tabindex', '0');
                        
                        const thumbnailImg = document.createElement('img');
                        thumbnailImg.src = photo.src;
                        thumbnailImg.alt = photo.alt;
                        
                        thumbnail.appendChild(thumbnailImg);
                        photoThumbnails.appendChild(thumbnail);
                        
                        // Add click event to thumbnail
                        thumbnail.addEventListener('click', () => {
                            changeImage(i);
                        });
                        
                        // Add keyboard event for accessibility
                        thumbnail.addEventListener('keydown', (event) => {
                            if (event.key === 'Enter' || event.key === ' ') {
                                event.preventDefault();
                                changeImage(i);
                            }
                        });
                    }
                });
            }
            
            // Handle keyboard navigation
            function handleKeyNavigation(event) {
                if (!photoModal.classList.contains('active')) return;
                
                const currentIndex = Array.from(document.querySelectorAll('.photo-modal-thumbnail')).findIndex(
                    thumb => thumb.classList.contains('active')
                );
                
                switch (event.key) {
                    case 'ArrowLeft':
                        event.preventDefault();
                        changeImage(currentIndex - 1);
                        break;
                    case 'ArrowRight':
                        event.preventDefault();
                        changeImage(currentIndex + 1);
                        break;
                    case 'Escape':
                        event.preventDefault();
                        photoModal.classList.remove('active');
                        document.removeEventListener('keydown', handleKeyNavigation);
                        break;
                }
            }
            
            // Clean up event listener when modal is closed
            modalClose.addEventListener('click', () => {
                document.removeEventListener('keydown', handleKeyNavigation);
            });
        });
    </script>
</body>
</html>