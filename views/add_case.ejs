<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add New Case - Doctor Portal</title>
    <link rel="stylesheet" href="/assets/css/side_menu.css">
    <link rel="stylesheet" href="/assets/css/add_case.css">
    <link rel="stylesheet" href="/assets/css/date-picker.css">
    <link rel="stylesheet" href="/assets/css/validation.css">
    <link rel="stylesheet" href="/assets/css/toast.css">
    <script src="/assets/js/components.js"></script>
    <script src="/assets/js/date-picker.js"></script>

</head>
<body>
    <!-- Navigation Rail Component -->
    <div id="navRail"></div>
    <!-- Main Content -->
    <main class="main-content">
        <div class="content-container">
            <!-- Breadcrumb -->
            <nav class="breadcrumb">
                <a href="/aligners-cases" class="breadcrumb-item">Home</a>
                <span class="breadcrumb-separator">
                    <img src="/assets/images/breadcrumb-arrow.svg" alt="Breadcrumb Arrow">
                </span>
                <span class="breadcrumb-item active">Add New Case</span>
            </nav>

            <!-- Page Header -->
            <div class="page-header">
                <h1 class="page-title">Add New Case</h1>
            </div>

            <!-- Add Case Form -->
            <form class="add-case-form" id="addCaseForm">
                <!-- Patient Details Section -->
                <div class="form-section">
                    <h2 class="section-title">Patient Details</h2>
                    <div class="form-content">
                        <div class="form-grid">
                        <div class="form-field">
                            <label for="patientName">
                                <span class="required-asterisk">*</span>
                                <span class="label-text">Name</span>
                            </label>
                            <input type="text" id="patientName" name="patientName" placeholder="Input here">
                        </div>
                        <div class="form-field">
                            <label for="patientGender">
                                <span class="required-asterisk">*</span>
                                <span class="label-text">Gender</span>
                            </label>
                            <div class="select-wrapper">
                                <select id="patientGender" name="patientGender">
                                    <option value="">Select</option>
                                    <option value="Male">Male</option>
                                    <option value="Female">Female</option>
                                    <option value="Prefer not to say">Prefer not to say</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-field">
                            <label for="dateOfBirth">
                                <span class="required-asterisk">*</span>
                                <span class="label-text">Date of Birth</span>
                            </label>
                            <div class="date-wrapper">
                                <input type="date" id="dateOfBirth" name="dateOfBirth" data-date-picker>
                            </div>
                        </div>
                        <div class="form-field">
                            <label for="email">
                                <span class="label-text"></span>Email</span>
                            </label>
                            <input type="email" id="email" name="email" placeholder="Input here">
                        </div>
                        <div class="form-field">
                            <label for="treatmentBrand">
                                <span class="required-asterisk">*</span>
                                <span class="label-text">Treatment Brand</span>
                            </label>
                            <div class="select-wrapper">
                                <select id="treatmentBrand" name="treatmentBrand">
                                    <option value="">Select</option>
                                    <option value="DCA Pro">DCA Pro</option>
                                    <option value="Diamond Aligner">Diamond Aligner</option>
                                    <option value="OEM-Plain">OEM-Plain</option>
                                    <option value="OEM-Clinic Brand">OEM-Clinic Brand</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-field">
                            <label for="customSN">
                                <span class="label-text">Custom SN</span>
                            </label>
                            <input type="text" id="customSN" name="customSN" placeholder="Input here">
                        </div>
                    </div>
                    </div>
                </div>

                <!-- Treatment Details Section -->
                <div class="form-section">
                    <h2 class="section-title">Treatment Details</h2>
                    <div class="form-content">
                    
                    <!-- Clinical Condition -->
                    <div class="clinical-condition">
                        <h3 class="subsection-title">Clinical Condition</h3>
                        <div class="condition-grid">
                            <div class="condition-row">
                                <label class="checkbox-label">
                                    <input type="checkbox" name="clinical_condition" value="crowding">
                                    <span class="checkmark"></span>
                                    Crowding
                                </label>
                            </div>
                            <div class="condition-row">
                                <label class="checkbox-label">
                                    <input type="checkbox" name="clinical_condition" value="class_ii_div_1">
                                    <span class="checkmark"></span>
                                    Class II div 1
                                </label>
                            </div>
                            <div class="condition-row">
                                <label class="checkbox-label">
                                    <input type="checkbox" name="clinical_condition" value="overjet">
                                    <span class="checkmark"></span>
                                    Overjet
                                </label>
                            </div>
                            <div class="condition-row">
                                <label class="checkbox-label">
                                    <input type="checkbox" name="clinical_condition" value="deep_bite">
                                    <span class="checkmark"></span>
                                    Deep Bite
                                </label>
                            </div>
                            <div class="condition-row">
                                <label class="checkbox-label">
                                    <input type="checkbox" name="clinical_condition" value="class_ii_div_2">
                                    <span class="checkmark"></span>
                                    Class II div 2
                                </label>
                            </div>
                            <div class="condition-row">
                                <label class="checkbox-label">
                                    <input type="checkbox" name="clinical_condition" value="anterior_crossbite">
                                    <span class="checkmark"></span>
                                    Anterior Crossbite
                                </label>
                            </div>
                            <div class="condition-row">
                                <label class="checkbox-label">
                                    <input type="checkbox" name="clinical_condition" value="spacing">
                                    <span class="checkmark"></span>
                                    Spacing
                                </label>
                            </div>
                            <div class="condition-row">
                                <label class="checkbox-label">
                                    <input type="checkbox" name="clinical_condition" value="class_iii">
                                    <span class="checkmark"></span>
                                    Class III
                                </label>
                            </div>
                            <div class="condition-row">
                                <label class="checkbox-label">
                                    <input type="checkbox" name="clinical_condition" value="posterior_crossbite">
                                    <span class="checkmark"></span>
                                    Posterior Crossbite
                                </label>
                            </div>
                            <div class="condition-row">
                                <label class="checkbox-label">
                                    <input type="checkbox" name="clinical_condition" value="narrow_arch">
                                    <span class="checkmark"></span>
                                    Narrow Arch
                                </label>
                            </div>
                            <div class="condition-row">
                                <label class="checkbox-label">
                                    <input type="checkbox" name="clinical_condition" value="open_bite">
                                    <span class="checkmark"></span>
                                    Open Bite
                                </label>
                            </div>
                            <div class="condition-row">
                                <label class="checkbox-label">
                                    <input type="checkbox" name="clinical_condition" value="others">
                                    <span class="checkmark"></span>
                                    Others
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- IPR and Attachments -->
                    <div class="ipr-attachments">
                        <div class="form-field">
                            <label for="ipr">
                                <span class="required-asterisk">*</span>
                                <span class="label-text">IPR</span>
                            </label>
                            <div class="select-wrapper">
                                <select id="ipr" name="ipr">
                                    <option value="">Select</option>
                                    <option value="Yes">Yes</option>
                                    <option value="No">No</option>
                                    <option value="As Recommended">As Recommended</option>
                                </select>
                            </div>
                            
                        </div>
                        <div class="form-field">
                            <label for="attachments">
                                <span class="required-asterisk">*</span>
                                <span class="label-text">Attachments</span>
                            </label>
                            <div class="select-wrapper">
                                <select id="attachments" name="attachments">
                                    <option value="">Select</option>
                                    <option value="Yes">Yes</option>
                                    <option value="No">No</option>
                                    <option value="As Recommended">As Recommended</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Treatment Notes -->
                    <div class="form-field full-width">
                        <label for="treatmentNotes">
                            <span class="label-text">Treatment Notes</span>
                        </label>
                        <textarea id="treatmentNotes" name="treatmentNotes" placeholder="Input here" rows="6"></textarea>
                    </div>
                    </div>
                </div>

                <!-- Model Upload Section -->
                <div class="form-section">
                    <h2 class="section-title">Model Upload</h2>
                    <div class="form-content">
                    
                        <div class="form-field">
                            <label for="modelType">
                                <span class="required-asterisk">*</span>
                                <span class="label-text">Model Type</span>
                            </label>
                            <div class="select-wrapper">
                                <select id="modelType" name="modelType">
                                    <option value="">Select</option>
                                    <option value="Digital Model">Digital Model</option>
                                    <option value="Plaster Model">Plaster Model</option>
                                </select>
                            </div>
                        </div>

                        <!-- File Upload Grid -->
                        <div class="upload-grid">
                            <div class="upload-field">
                                <label for="upperScan">
                                    <span class="required-asterisk">*</span>
                                    <span class="label-text">Upper Scan (*STL/*PLY)</span>
                                </label>
                                <div class="file-upload file-upload-simple">
                                    <input type="file" id="upperScan" name="upperScan" accept=".stl,.ply">
                                    <div class="upload-placeholder">
                                        <span>Choose File</span>
                                        <img src="/assets/images/file-upload.png" alt="Upload Icon" class="file-upload-icon">
                                    </div>
                                </div>
                                <div class="field-error-message"></div>
                            </div>
                            <div class="upload-field">
                                <label for="lowerScan">
                                    <span class="required-asterisk">*</span>
                                    <span class="label-text">Lower Scan (*STL/*PLY)</span>
                                </label>
                                <div class="file-upload file-upload-simple">
                                    <input type="file" id="lowerScan" name="lowerScan" accept=".stl,.ply">
                                    <div class="upload-placeholder">
                                        <span>Choose File</span>
                                        <img src="/assets/images/file-upload.png" alt="Upload Icon" class="file-upload-icon">
                                    </div>
                                </div>
                                <div class="field-error-message"></div>
                            </div>
                            <div class="upload-field">
                                <label for="biteScan">
                                    <span class="label-text">Bite Scan (*STL/PLY)</span>
                                </label>
                                <div class="file-upload file-upload-simple">
                                    <input type="file" id="biteScan" name="biteScan" accept=".stl,.ply">
                                    <div class="upload-placeholder">
                                        <span>Choose File</span>
                                        <img src="/assets/images/file-upload.png" alt="Upload Icon" class="file-upload-icon">
                                    </div>
                                </div>
                                <div class="field-error-message"></div>
                            </div>
                        </div>

                        <!-- Clinical Photos -->
                        <div class="clinical-photos">
                            <h3 class="subsection-title">Clinical Photos</h3>
                            <p class="upload-instructions">Please click on the images below to upload photos</p>
                            
                            <div class="photo-grid">
                                <div class="photo-row">
                                    <div class="photo-upload face-photo" data-type="frontal">
                                        <img src="/assets/images/full-face-front.png" alt="Face Front" class="photo-outline">
                                        <input type="file" id="frontal" accept="image/*" style="display: none;">
                                    </div>
                                    <div class="photo-upload face-photo" data-type="smile">
                                        <img src="/assets/images/full-smiling-face.png" alt="Face Smile" class="photo-outline">
                                        <input type="file" id="smile" accept="image/*" style="display: none;">
                                    </div>
                                    <div class="photo-upload face-photo" data-type="profile">
                                        <img src="/assets/images/right-side-profile.png" alt="Face Profile" class="photo-outline">
                                        <input type="file" id="profile" accept="image/*" style="display: none;">
                                    </div>
                                </div>
                                
                                <div class="photo-row">
                                    <div class="photo-upload teeth-photo" data-type="left">
                                        <img src="/assets/images/buccal-right.png" alt="Teeth Left" class="photo-outline">
                                        <input type="file" id="left" accept="image/*" style="display: none;">
                                    </div>
                                    <div class="photo-upload teeth-photo" data-type="front">
                                        <img src="/assets/images/bretracted-anterior-frontal.png" alt="Teeth Front" class="photo-outline">
                                        <input type="file" id="front" accept="image/*" style="display: none;">
                                    </div>
                                    <div class="photo-upload teeth-photo" data-type="right">
                                        <img src="/assets/images/buccal-left.png" alt="Teeth Right" class="photo-outline">
                                        <input type="file" id="right" accept="image/*" style="display: none;">
                                    </div>
                                    <div class="photo-upload teeth-photo" data-type="upper">
                                        <img src="/assets/images/mandibular-occlusal.png" alt="Teeth Upper" class="photo-outline">
                                        <input type="file" id="upper" accept="image/*" style="display: none;">
                                    </div>
                                    <div class="photo-upload teeth-photo" data-type="lower">
                                        <img src="/assets/images/maxillary-occlusal.png" alt="Teeth Lower" class="photo-outline">
                                        <input type="file" id="lower" accept="image/*" style="display: none;">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- X-Ray Upload -->
                        <div class="upload-field full-width">
                            <label for="xray">
                                <span class="label-text">X-Ray (*JPEG, PNG or ZIP)</span>
                            </label>
                            <div class="file-upload file-upload-simple">
                                <input type="file" id="xray" name="xray" accept=".jpg,.jpeg,.png,.zip">
                                <div class="upload-placeholder">
                                    <span>Choose File</span>
                                    <img src="/assets/images/file-upload.png" id="xray" alt="Upload Icon" class="file-upload-icon">
                                </div>
                            </div>
                        </div>

                        <!-- Other Documents Upload -->
                        <div class="upload-field full-width">
                            <label for="documents">
                                <span class="label-text">Other Documents / Photos (*JPEG, PNG or ZIP)</span>
                            </label>
                            <div class="file-upload file-upload-simple">
                                <input type="file" id="documents" name="documents" accept=".jpg,.jpeg,.png,.zip">
                                <div class="upload-placeholder">
                                    <span>Choose File</span>
                                    <img src="/assets/images/file-upload.png" id="documents" alt="Upload Icon" class="file-upload-icon">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="saveDraftBtn">Save as Draft</button>
                    <button type="submit" class="btn btn-primary" id="submitBtn">Submit</button>
                </div>
            </form>
        </div>
    </main>
    <script src="/assets/js/jquery.js"></script>
    <script src="/assets/js/axios.min.js"></script>
    <script src="/assets/js/toast.js"></script>
    <script>
        // Load navigation rail component
        document.addEventListener('DOMContentLoaded', () => {
            loadComponent('navRail', '/components/side-menu');
        });

        // File upload handling
        document.querySelectorAll('.file-upload input[type="file"]').forEach(input => {
            input.addEventListener('change', function() {
                const uploadPlaceholder = this.parentNode.querySelector('.upload-placeholder');
                const firstSpan = uploadPlaceholder.querySelector('span:first-child');
                
                if (this.files.length > 0) {
                    if (this.parentNode.classList.contains('file-upload-simple')) {
                        firstSpan.textContent = this.files[0].name;
                        
                        // Add cancel button for uploaded file
                        let cancelBtn = uploadPlaceholder.querySelector('.cancel-upload');
                        if (!cancelBtn) {
                            cancelBtn = document.createElement('button');
                            cancelBtn.className = 'cancel-upload';
                            cancelBtn.type = 'button';
                            cancelBtn.innerHTML = '<img src="/assets/images/cancel-file-upload.svg" alt="Remove file">';
                            uploadPlaceholder.appendChild(cancelBtn);
                            
                            // Add click handler to remove file
                            cancelBtn.addEventListener('click', (e) => {
                                e.preventDefault();
                                e.stopPropagation();
                                
                                // Clear the file input
                                this.value = '';
                                
                                // Reset the UI
                                firstSpan.textContent = 'Choose File';
                                this.parentNode.classList.remove('has-file');
                                cancelBtn.remove();
                                
                                // Clear any validation state
                                if (window.formValidation) {
                                    window.formValidation.clearValidation(this);
                                }
                            });
                        }
                    } else {
                        firstSpan.textContent = this.files[0].name;
                    }
                    this.parentNode.classList.add('has-file');
                } else {
                    firstSpan.textContent = 'Choose File';
                    this.parentNode.classList.remove('has-file');
                    
                    // Remove cancel button if it exists
                    const cancelBtn = uploadPlaceholder.querySelector('.cancel-upload');
                    if (cancelBtn) {
                        cancelBtn.remove();
                    }
                }
            });
        });

        // Clinical photos drag and drop
        document.querySelectorAll('.photo-upload').forEach(upload => {
            const input = upload.querySelector('input[type="file"]');
            
            // Add a clear button to remove uploaded images
            const clearButton = document.createElement('div');
            clearButton.className = 'clear-photo';
            clearButton.innerHTML = '×';
            clearButton.style.display = 'none';
            clearButton.style.position = 'absolute';
            clearButton.style.top = '5px';
            clearButton.style.right = '5px';
            clearButton.style.backgroundColor = 'rgba(255, 255, 255, 0.7)';
            clearButton.style.borderRadius = '50%';
            clearButton.style.width = '24px';
            clearButton.style.height = '24px';
            clearButton.style.textAlign = 'center';
            clearButton.style.lineHeight = '22px';
            clearButton.style.fontSize = '18px';
            clearButton.style.cursor = 'pointer';
            clearButton.style.zIndex = '10';
            upload.style.position = 'relative';
            upload.appendChild(clearButton);
            
            clearButton.addEventListener('click', (e) => {
                e.stopPropagation();
                input.value = '';
                upload.style.backgroundImage = '';
                const photoOutline = upload.querySelector('.photo-outline');
                if (photoOutline) {
                    photoOutline.style.display = '';
                }
                clearButton.style.display = 'none';
            });
            
            upload.addEventListener('click', () => {
                input.click();
            });

            upload.addEventListener('dragover', (e) => {
                e.preventDefault();
                upload.classList.add('drag-over');
            });

            upload.addEventListener('dragleave', () => {
                upload.classList.remove('drag-over');
            });

            upload.addEventListener('drop', (e) => {
                e.preventDefault();
                upload.classList.remove('drag-over');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    input.files = files;
                    const event = new Event('change', { bubbles: true });
                    input.dispatchEvent(event);
                    
                    // Show preview
                    const file = files[0];
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            upload.style.backgroundImage = `url(${e.target.result})`;
                            upload.style.backgroundSize = 'cover';
                            upload.style.backgroundPosition = 'center';
                            const photoOutline = upload.querySelector('.photo-outline');
                            if (photoOutline) {
                                photoOutline.style.display = 'none';
                            }
                            const clearButton = upload.querySelector('.clear-photo');
                            if (clearButton) {
                                clearButton.style.display = 'block';
                            }
                        };
                        reader.readAsDataURL(file);
                    }
                }
            });

            input.addEventListener('change', function() {
                if (this.files.length > 0) {
                    const file = this.files[0];
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            upload.style.backgroundImage = `url(${e.target.result})`;
                            upload.style.backgroundSize = 'cover';
                            upload.style.backgroundPosition = 'center';
                            const photoOutline = upload.querySelector('.photo-outline');
                            if (photoOutline) {
                                photoOutline.style.display = 'none';
                            }
                            const clearButton = upload.querySelector('.clear-photo');
                            if (clearButton) {
                                clearButton.style.display = 'block';
                            }
                        };
                        reader.readAsDataURL(file);
                    }
                }
            });
        });

        // Validation rules
        const validations = [
            {
                field: 'patientName',
                rule: 'required',
                message: 'Name is required.'
            },
            {
                field: 'patientGender',
                rule: 'required',
                message: 'Gender is required.'
            },
            {
                field: 'dateOfBirth',
                rule: 'required',
                message: 'Date of Birth is required.'
            },
            {
                field: 'treatmentBrand',
                rule: 'required',
                message: 'Treatment Brand is required.'
            },
            {
                field: 'ipr',
                rule: 'required',
                message: 'IPR is required.'
            },
            {
                field: 'attachments',
                rule: 'required',
                message: 'Attachments is required.'
            },
            {
                field: 'modelType',
                rule: 'required',
                message: 'Model Type is required.'
            },
            {
                field: 'upperScan',
                rule: 'required',
                message: 'Upper Scan is required.'
            },
            {
                field: 'lowerScan',
                rule: 'required',
                message: 'Lower Scan is required.'
            }
        ];

        // Function to handle form submission
        async function handleFormSubmission(status, button) {
            // Clear any existing validation errors
            formValidation.clearAllValidation('createUserForm');
            formValidation.clearFormError('createUserForm');

            // For drafts, skip validation
            //if (status === '1') {
                // Validate all fields for submission
                const isValid = formValidation.validateFields(validations);
                if (!isValid) {
                    return;
                }
            //}

            // Disable button and show loading state
            const originalText = button.textContent;
            button.disabled = true;
            button.classList.add('loading');
            button.textContent = status === '1' ? 'Submitting Case...' : 'Saving Draft...';

            const formData = new FormData();
            formData.append('name', document.getElementById('patientName').value);
            formData.append('gender', document.getElementById('patientGender').value);
            formData.append('email', document.getElementById('email').value);
            formData.append('dob', document.getElementById('dateOfBirth').value);
            formData.append('treatment_brand', document.getElementById('treatmentBrand').value);
            formData.append('custom_sn', document.getElementById('customSN').value);

            //clinical conditions - send individual boolean values for each condition
            const conditionCheckboxes = document.querySelectorAll('input[name="clinical_condition"]');
            conditionCheckboxes.forEach(checkbox => {
                formData.append(checkbox.value, checkbox.checked ? '1' : '0');
            });
            formData.append('ipr', document.getElementById('ipr').value);
            formData.append('attachments', document.getElementById('attachments').value);
            formData.append('treatment_notes', document.getElementById('treatmentNotes').value); 
            
            //model type
            formData.append('model_type', document.getElementById('modelType').value);
            
            // File uploads - append actual files, not values
            const upperScanFile = document.getElementById('upperScan').files[0];
            const lowerScanFile = document.getElementById('lowerScan').files[0];
            const biteScanFile = document.getElementById('biteScan').files[0];
            
            if (upperScanFile) formData.append('upper_scan', upperScanFile);
            if (lowerScanFile) formData.append('lower_scan', lowerScanFile);
            if (biteScanFile) formData.append('bite_scan', biteScanFile);

            //clinical photos - append actual files, not values
            const frontalFile = document.getElementById('frontal').files[0];
            const smileFile = document.getElementById('smile').files[0];
            const profileFile = document.getElementById('profile').files[0];
            const leftFile = document.getElementById('left').files[0];
            const frontFile = document.getElementById('front').files[0];
            const rightFile = document.getElementById('right').files[0];
            const upperFile = document.getElementById('upper').files[0];
            const lowerFile = document.getElementById('lower').files[0];
            const xrayFile = document.getElementById('xray').files[0];
            const documentsFile = document.getElementById('documents').files[0];

            if (frontalFile) formData.append('front', frontalFile);
            if (smileFile) formData.append('smiling', smileFile);
            if (profileFile) formData.append('right_side', profileFile);
            if (leftFile) formData.append('buccal_top', leftFile);
            if (frontFile) formData.append('buccal_bottom', frontFile);
            if (rightFile) formData.append('buccal_right', rightFile);
            if (upperFile) formData.append('buccal_center', upperFile);
            if (lowerFile) formData.append('buccal_left', lowerFile);
            if (xrayFile) formData.append('xray', xrayFile);
            if (documentsFile) formData.append('other', documentsFile);

            formData.append('xray', document.getElementById('xray').value);
            formData.append('other', document.getElementById('documents').value);
            formData.append('status', status);
            formData.append('category', 'New Case');

            try {
                const response = await axios.post('/add-case', formData, {
                    headers: {
                        'Content-Type': 'multipart/form-data'
                    }
                });
                
                // Redirect to cases list with success message
                window.location.href = `/aligners-cases?success=${encodeURIComponent(response.data.message)}`;
            } catch (error) {
                console.error('Error adding case:', error);
                Toast.error(status === '1' ? 
                    'Failed to submit case. Please try again.' : 
                    'Failed to save draft. Please try again.');
            } finally {
                // Reset button state
                button.disabled = false;
                button.classList.remove('loading');
                button.textContent = originalText;
            }
        }

        // Form submission event listeners
        document.getElementById('submitBtn').addEventListener('click', async (e) => {
            e.preventDefault();
            await handleFormSubmission('1', e.target);
        });

        document.getElementById('saveDraftBtn').addEventListener('click', async (e) => {
            e.preventDefault();
            await handleFormSubmission('0', e.target);
        });
    </script>
</body>
</html>
