<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aligners Cases - Doctor Portal</title>
    <link rel="stylesheet" href="/assets/css/side_menu.css">
    <link rel="stylesheet" href="/assets/css/user_management.css">
    <script src="/assets/js/components.js"></script>
</head>
<body>
    <!-- Top header hidden for rail layout -->
    <header class="header" aria-hidden="true"></header>

    <!-- Navigation Rail Component -->
    <div id="navRail"></div>

    <!-- Main Content -->
    <main class="main-content">
        <div class="content-container">
            <!-- Page Header -->
            <div class="page-header">
                <h1 class="page-title">User Management</h1>
                <div class="page-actions">
                    <button class="btn btn-primary" id="createUserBtn">
                        Create User
                    </button>
                </div>
            </div>

             <!-- Search and Filters -->
             <div class="search-filters-section">
                <div class="search-container">
                    <div class="search-input-wrapper">
                        <img src="/assets/images/search-icon.svg" class="search-icon" alt="Search">
                        <input type="text" placeholder="Search name" class="search-input" id="searchInput">
                    </div>
                </div>

                <div class="filters-container">
                    <!-- Custom styled dropdown to match design -->
                    <div class="chip-select custom-dropdown" id="countryDropdown">
                        <button type="button" class="chip-button" id="countryButton">
                            <span class="chip-button-label">Country</span>
                            <img src="/assets/images/select-icon.svg" class="chip-caret" alt="Select">
                        </button>
                        <div class="chip-menu" id="countryMenu">
                            <button class="chip-menu-item" data-value="malaysia">Malaysia</button>
                            <button class="chip-menu-item" data-value="singapore">Singapore</button>
                        </div>
                        <!-- hidden native select for value storage and keyboard fallback -->
                        <select class="chip-input native-select" id="countryFilter" hidden>
                            <option value="">Country</option>
                            <option value="malaysia">Malaysia</option>
                            <option value="singapore">Singapore</option>
                        </select>
                    </div>

                    <!-- Custom styled dropdown to match design -->
                    <div class="chip-select custom-dropdown" id="roleDropdown">
                        <button type="button" class="chip-button" id="roleButton">
                            <span class="chip-button-label">Role</span>
                            <img src="/assets/images/select-icon.svg" class="chip-caret" alt="Select">
                        </button>
                        <div class="chip-menu" id="roleMenu">
                            <button class="chip-menu-item" data-value="superadmin">Superadmin</button>
                            <button class="chip-menu-item" data-value="doctor">Doctor</button>
                            <button class="chip-menu-item" data-value="staff">Staff</button>
                        </div>
                        <!-- hidden native select for value storage and keyboard fallback -->
                        <select class="chip-input native-select" id="roleFilter" hidden>
                            <option value="">Role</option>
                            <option value="superadmin">Superadmin</option>
                            <option value="doctor">Doctor</option>
                            <option value="staff">Staff</option>
                        </select>
                    </div>
                    <button class="filter-reset" id="resetFilters">Reset</button>
                </div>
            </div>

            <!-- Status Tabs -->
            <div class="status-tabs">
                <div class="tab-list" role="tablist">
                    <button class="tab-button active" data-status="all" role="tab">
                        All <span class="tab-count">30</span>
                    </button>
                    <button class="tab-button" data-status="active" role="tab">
                        Active <span class="tab-count">4</span>
                    </button>
                    <button class="tab-button" data-status="inactive" role="tab">
                        Inactive <span class="tab-count">26</span>
                    </button>
                </div>
            </div>

             <!-- Users Table -->
             <div class="users-table-container">
                <table class="users-table" id="usersTable">
                    <thead>
                        <tr>
                            <th class="th-name">Name</th>
                            <th class="th-country">Country</th>
                            <th class="th-role">Role</th>
                            <th class="th-created-at sortable" data-sort="created">
                                Created At 
                                <span class="sort-icon">↕</span>
                            </th>
                            <th class="th-last-login sortable" data-sort="last-login">
                                Last Login 
                                <span class="sort-icon">↕</span>
                            </th>
                            <th class="th-status">Status</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <!-- Users will be loaded dynamically via JavaScript -->
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="pagination-container">
                <div class="pagination-info">
                    <label class="entries-label">
                        Show 
                        <select class="entries-select" id="entriesPerPage">
                            <option value="10" selected>10</option>
                            <option value="25">25</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                        entries
                    </label>
                    <span id="paginationInfo">Showing 0 to 0 of 0 entries</span>
                </div>
                
                <nav class="pagination-nav" aria-label="Pagination Navigation" id="paginationNav">
                    <!-- Pagination buttons will be generated dynamically -->
                </nav>
            </div>

            <!-- Empty State -->
            <div class="empty-state" id="emptyState" style="display: none;">
                <div class="empty-icon">
                    <svg viewBox="0 0 24 24" fill="none">
                        <path d="M9 11H15M9 15H15M17 21H7C5.89543 21 5 20.1046 5 19V5C5 3.89543 5.89543 3 7 3H12.5858C12.851 3 13.1054 3.10536 13.2929 3.29289L19.7071 9.70711C19.8946 9.89464 20 10.149 20 10.4142V19C20 20.1046 19.1046 21 18 21H17Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
                <h3 class="empty-title">No users found</h3>
                <p class="empty-description">Try adjusting your search or filter criteria</p>
            </div>

            <!-- Loading State -->
            <div class="loading-state" id="loadingState" style="display: none; text-align: center; padding: 2rem;">
                <p>Loading users...</p>
            </div>
        </div>
    </main>

    <script>
        // Load navigation rail component
        document.addEventListener('DOMContentLoaded', () => {
            loadComponent('navRail', '/components/side-menu');
            
            // User management functionality
            let currentFilters = {
                search: '',
                country: '',
                role: '',
                sortBy: 'created_at',
                sortOrder: 'DESC',
                limit: 10,
                offset: 0
            };
            
            let currentPage = 1;
            let totalUsers = 0;

            // Create user button
            const createUserBtn = document.getElementById('createUserBtn');
            createUserBtn.addEventListener('click', () => {
                window.location.href = '/create-user';
            });

            // DOM elements
            const searchInput = document.getElementById('searchInput');
            const countryFilter = document.getElementById('countryFilter');
            const roleFilter = document.getElementById('roleFilter');
            const resetFilters = document.getElementById('resetFilters');
            const usersTableBody = document.getElementById('usersTableBody');
            const emptyState = document.getElementById('emptyState');
            const loadingState = document.getElementById('loadingState');
            const entriesPerPage = document.getElementById('entriesPerPage');
            const paginationInfo = document.getElementById('paginationInfo');
            const paginationNav = document.getElementById('paginationNav');

            // Load users from API
            async function loadUsers() {
                try {
                    loadingState.style.display = 'block';
                    emptyState.style.display = 'none';
                    usersTableBody.parentElement.parentElement.style.display = 'block';

                    const params = new URLSearchParams();
                    Object.keys(currentFilters).forEach(key => {
                        if (currentFilters[key]) {
                            params.append(key, currentFilters[key]);
                        }
                    });

                    const response = await fetch(`/api/users?${params.toString()}`);
                    if (!response.ok) {
                        throw new Error('Failed to fetch users');
                    }

                    const data = await response.json();
                    totalUsers = data.total;
                    
                    renderUsers(data.users);
                    updatePagination();
                    updatePaginationInfo();
                    
                } catch (error) {
                    console.error('Error loading users:', error);
                    showError('Failed to load users');
                } finally {
                    loadingState.style.display = 'none';
                }
            }

            // Render users in table
            function renderUsers(users) {
                usersTableBody.innerHTML = '';
                
                if (users.length === 0) {
                    emptyState.style.display = 'flex';
                    usersTableBody.parentElement.parentElement.style.display = 'none';
                    return;
                }

                users.forEach(user => {
                    const row = document.createElement('tr');
                    row.className = 'table-row';
                    row.setAttribute('data-user-id', user.id);
                    
                    const formatDate = (dateString) => {
                        if (!dateString) return 'Never';
                        return new Date(dateString).toLocaleDateString('en-GB');
                    };

                    row.innerHTML = `
                        <td class="td-name">${escapeHtml(user.fullName)}</td>
                        <td class="td-country">${escapeHtml(user.country)}</td>
                        <td class="td-role">${escapeHtml(user.role)}</td>
                        <td class="td-created-at">${formatDate(user.created_at)}</td>
                        <td class="td-last-login">${formatDate(user.last_login)}</td>
                        <td class="td-status">
                            <span class="status-badge status-active">Active</span>
                        </td>
                    `;
                    
                    usersTableBody.appendChild(row);
                });

                emptyState.style.display = 'none';
                usersTableBody.parentElement.parentElement.style.display = 'block';
            }

            // Escape HTML to prevent XSS
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            // Update pagination controls
            function updatePagination() {
                const totalPages = Math.ceil(totalUsers / currentFilters.limit);
                paginationNav.innerHTML = '';

                if (totalPages <= 1) return;

                // Previous button
                const prevBtn = document.createElement('button');
                prevBtn.className = 'pagination-btn prev-btn';
                prevBtn.disabled = currentPage === 1;
                prevBtn.innerHTML = '<img src="/assets/images/left-arrow-pagination-inactive.svg" class="pagination-icon" alt="Previous">';
                prevBtn.addEventListener('click', () => goToPage(currentPage - 1));
                paginationNav.appendChild(prevBtn);

                // Page numbers container
                const numbersDiv = document.createElement('div');
                numbersDiv.className = 'pagination-numbers';

                // Generate page buttons (simplified logic)
                for (let i = 1; i <= Math.min(totalPages, 10); i++) {
                    const pageBtn = document.createElement('button');
                    pageBtn.className = 'pagination-btn page-btn';
                    pageBtn.textContent = i;
                    pageBtn.setAttribute('data-page', i);
                    
                    if (i === currentPage) {
                        pageBtn.classList.add('active');
                    }
                    
                    pageBtn.addEventListener('click', () => goToPage(i));
                    numbersDiv.appendChild(pageBtn);
                }

                paginationNav.appendChild(numbersDiv);

                // Next button
                const nextBtn = document.createElement('button');
                nextBtn.className = 'pagination-btn next-btn';
                nextBtn.disabled = currentPage === totalPages;
                nextBtn.innerHTML = '<img src="/assets/images/right-arrow-pagination-active.svg" class="pagination-icon" alt="Next">';
                nextBtn.addEventListener('click', () => goToPage(currentPage + 1));
                paginationNav.appendChild(nextBtn);
            }

            // Update pagination info text
            function updatePaginationInfo() {
                const start = (currentPage - 1) * currentFilters.limit + 1;
                const end = Math.min(currentPage * currentFilters.limit, totalUsers);
                paginationInfo.textContent = `Showing ${start} to ${end} of ${totalUsers} entries`;
            }

            // Go to specific page
            function goToPage(page) {
                const totalPages = Math.ceil(totalUsers / currentFilters.limit);
                if (page < 1 || page > totalPages) return;
                
                currentPage = page;
                currentFilters.offset = (page - 1) * currentFilters.limit;
                loadUsers();
            }

            // Show error message
            function showError(message) {
                // You could implement a toast notification here
                console.error(message);
            }

            // Debounce function for search input
            function debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }

            // Filter function
            function applyFilters() {
                currentPage = 1;
                currentFilters.offset = 0;
                loadUsers();
            }

            // Event listeners
            searchInput.addEventListener('input', debounce(() => {
                currentFilters.search = searchInput.value.trim();
                applyFilters();
            }, 300));

            // Custom dropdown (Country)
            const countryButton = document.getElementById('countryButton');
            const countryMenu = document.getElementById('countryMenu');
            const nativeCountrySelect = document.getElementById('countryFilter');
            const countryLabel = countryButton.querySelector('.chip-button-label');
            
            countryButton.addEventListener('click', (e) => {
                e.stopPropagation();
                countryMenu.classList.toggle('open');
            });
            
            document.addEventListener('click', () => countryMenu.classList.remove('open'));
            
            countryMenu.querySelectorAll('.chip-menu-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    const value = e.currentTarget.getAttribute('data-value');
                    const text = e.currentTarget.textContent.trim();
                    nativeCountrySelect.value = value;
                    countryLabel.textContent = text || 'Country';
                    countryMenu.classList.remove('open');
                    
                    currentFilters.country = value;
                    applyFilters();
                });
            });

            // Custom dropdown (Role)
            const roleButton = document.getElementById('roleButton');
            const roleMenu = document.getElementById('roleMenu');
            const nativeRoleSelect = document.getElementById('roleFilter');
            const roleLabel = roleButton.querySelector('.chip-button-label');
            
            roleButton.addEventListener('click', (e) => {
                e.stopPropagation();
                roleMenu.classList.toggle('open');
            });
            
            document.addEventListener('click', () => roleMenu.classList.remove('open'));
            
            roleMenu.querySelectorAll('.chip-menu-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    const value = e.currentTarget.getAttribute('data-value');
                    const text = e.currentTarget.textContent.trim();
                    nativeRoleSelect.value = value;
                    roleLabel.textContent = text || 'Role';
                    roleMenu.classList.remove('open');
                    
                    currentFilters.role = value;
                    applyFilters();
                });
            });

            // Reset filters
            resetFilters.addEventListener('click', () => {
                searchInput.value = '';
                nativeCountrySelect.value = '';
                nativeRoleSelect.value = '';
                countryLabel.textContent = 'Country';
                roleLabel.textContent = 'Role';
                
                currentFilters.search = '';
                currentFilters.country = '';
                currentFilters.role = '';
                applyFilters();
            });

            // Entries per page
            entriesPerPage.addEventListener('change', () => {
                currentFilters.limit = parseInt(entriesPerPage.value);
                currentPage = 1;
                currentFilters.offset = 0;
                loadUsers();
            });

            // Sorting functionality
            document.querySelectorAll('.sortable').forEach(header => {
                header.addEventListener('click', () => {
                    const sortType = header.getAttribute('data-sort');
                    let newSortBy = sortType;
                    
                    // Map frontend sort types to backend column names
                    if (sortType === 'created') newSortBy = 'created_at';
                    if (sortType === 'last-login') newSortBy = 'last_login';
                    
                    // Toggle sort order if same column
                    if (currentFilters.sortBy === newSortBy) {
                        currentFilters.sortOrder = currentFilters.sortOrder === 'ASC' ? 'DESC' : 'ASC';
                    } else {
                        currentFilters.sortBy = newSortBy;
                        currentFilters.sortOrder = 'DESC';
                    }
                    
                    // Update sort icons
                    document.querySelectorAll('.sortable .sort-icon').forEach(icon => {
                        icon.textContent = '↕';
                    });
                    
                    const sortIcon = header.querySelector('.sort-icon');
                    sortIcon.textContent = currentFilters.sortOrder === 'ASC' ? '↑' : '↓';
                    
                    applyFilters();
                });
            });

            // Table row click handlers
            document.addEventListener('click', (e) => {
                const row = e.target.closest('.table-row');
                if (row) {
                    const userId = row.getAttribute('data-user-id');
                    window.location.href = `/user-details/${userId}`;
                }
            });

            // Initial load
            loadUsers();
        });
    </script>
</body>
</html>